<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDP 개발직군 셀프 체크리스트</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #5a67d8;
            font-size: 2.5em;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
            line-height: 1.8;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .section-title {
            color: #5a67d8;
            font-size: 1.8em;
            margin-bottom: 20px;
            font-weight: 600;
            border-bottom: 3px solid #5a67d8;
            padding-bottom: 10px;
        }

        .user-info {
            margin-bottom: 30px;
        }

        .user-info input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 15px;
        }

        .user-info input:focus {
            outline: none;
            border-color: #5a67d8;
        }

        .job-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .job-option {
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            background: #f8fafc;
        }

        .job-option:hover {
            border-color: #5a67d8;
            background: #edf2f7;
        }

        .job-option.selected {
            border-color: #5a67d8;
            background: #5a67d8;
            color: white;
        }

        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .section-header.backend {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        }

        .section-header.frontend {
            background: linear-gradient(135deg, #38b2ac 0%, #319795 100%);
        }

        .section-header.common {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        .question-card {
            margin-bottom: 25px;
            padding: 25px;
            border-left: 5px solid #5a67d8;
            background: #f8fafc;
            border-radius: 8px;
        }

        .question-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
        }

        .score-options {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .score-option {
            padding: 15px 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .score-option:hover {
            border-color: #5a67d8;
            background: #edf2f7;
        }

        .score-option.selected {
            border-color: #5a67d8;
            background: #5a67d8;
            color: white;
        }

        .score-label {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 5px;
        }

        .score-desc {
            font-size: 0.9em;
            line-height: 1.4;
        }

        .experience-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            resize: vertical;
            min-height: 100px;
            margin-top: 10px;
        }

        .experience-input:focus {
            outline: none;
            border-color: #5a67d8;
        }

        .experience-input.error {
            border-color: #e53e3e;
            background-color: #fed7d7;
        }

        .progress-bar-container {
            background: #e2e8f0;
            border-radius: 10px;
            height: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .page-info {
            text-align: center;
            margin-bottom: 20px;
            color: #666;
            font-size: 1.1em;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 30px;
        }

        .nav-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .nav-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .nav-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .nav-btn.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .nav-btn.secondary:hover:not(:disabled) {
            background: #cbd5e0;
        }

        .results {
            display: none;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .summary-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .summary-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .comparison-card {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .comparison-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .comparison-item h4 {
            color: #5a67d8;
            margin-bottom: 10px;
        }

        .comparison-value {
            font-size: 2em;
            font-weight: bold;
            color: #2d3748;
        }

        .skill-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 5px solid #5a67d8;
        }

        .skill-name {
            font-weight: 600;
        }

        .skill-score {
            font-size: 1.2em;
            font-weight: bold;
            color: #5a67d8;
        }

        .recommendations {
            background: #fff5f5;
            border: 2px solid #fed7d7;
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
        }

        .recommendations h3 {
            color: #c53030;
            margin-bottom: 15px;
        }

        .recommendations ul {
            padding-left: 20px;
        }

        .recommendations li {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .required-indicator {
            color: #e53e3e;
            font-weight: bold;
            margin-left: 5px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #5a67d8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .share-section {
            background: #f0f8ff;
            border: 2px solid #5a67d8;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .share-section h3 {
            color: #5a67d8;
            margin-bottom: 15px;
        }

        .share-url {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            word-break: break-all;
        }

        @media (max-width: 768px) {
            .score-options {
                grid-template-columns: 1fr;
            }
            
            .job-options {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }

            .navigation-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CDP 개발직군 셀프 체크리스트</h1>
            <p>본 체크리스트는 직군별 갖추어야 할 주요 스킬을 스스로 점검할 수 있는 문항으로 구성되어 있습니다.<br>
            응답결과는 응답자 본인과 직책자에게만 공유되며, 향후 목표수립과 교육제도 설계 시 참고 자료로 활용됩니다.</p>
        </div>

        <!-- 로딩 화면 -->
        <div id="loading" class="loading">
            <div class="card">
                <div class="loading-spinner"></div>
                <p>결과를 분석하고 저장하는 중입니다...</p>
            </div>
        </div>

        <div id="job-selection" class="card">
            <div class="section-title">사용자 정보 및 직무 선택</div>
            
            <div class="user-info">
                <input type="text" id="user-name" placeholder="이름을 입력해주세요 (필수)" maxlength="20">
                <input type="text" id="user-department" placeholder="부서명을 입력해주세요 (선택)" maxlength="30">
                <input type="email" id="user-email" placeholder="이메일을 입력해주세요 (선택)" maxlength="50">
            </div>
            
            <p style="margin-bottom: 20px; color: #666;">본인의 직무를 선택해주세요. (이전 경험이나 앞으로의 성장 관점에서 확인하고 싶은 직무를 선택해도 무방합니다.)</p>
            <div class="job-options">
                <div class="job-option" data-job="fullstack">
                    <div style="font-weight: bold; margin-bottom: 10px;">풀스택 개발자</div>
                    <div style="font-size: 0.9em;">백엔드 + 프론트엔드 + 직무공통<br>(총 13문항)</div>
                </div>
                <div class="job-option" data-job="backend">
                    <div style="font-weight: bold; margin-bottom: 10px;">백엔드 개발자</div>
                    <div style="font-size: 0.9em;">백엔드 + 직무공통<br>(총 8문항)</div>
                </div>
                <div class="job-option" data-job="frontend">
                    <div style="font-weight: bold; margin-bottom: 10px;">프론트엔드 개발자</div>
                    <div style="font-size: 0.9em;">프론트엔드 + 직무공통<br>(총 8문항)</div>
                </div>
            </div>
            <div class="navigation-buttons">
                <button type="button" class="nav-btn" id="start-btn" disabled onclick="startAssessment()">
                    시작하기
                </button>
            </div>
        </div>

        <div id="assessment-form" style="display: none;">
            <div class="card">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <div class="page-info" id="page-info"></div>
                
                <div id="questions-container"></div>

                <div class="navigation-buttons">
                    <button type="button" class="nav-btn secondary" id="prev-btn" onclick="previousPage()" disabled>
                        이전
                    </button>
                    <button type="button" class="nav-btn" id="next-btn" onclick="nextPage()">
                        다음
                    </button>
                </div>
            </div>
        </div>

        <div id="results" class="results">
            <div class="card">
                <div class="section-title">🎯 개인별 역량 분석 결과</div>
                <div id="results-content"></div>
                
                <div class="share-section">
                    <h3>📎 결과 공유</h3>
                    <p>아래 링크를 통해 결과를 다시 확인하거나 공유할 수 있습니다.</p>
                    <div class="share-url" id="share-url"></div>
                    <button type="button" class="nav-btn" onclick="copyShareUrl()" style="margin-top: 10px; max-width: 200px;">
                        링크 복사
                    </button>
                </div>
                
                <button type="button" class="nav-btn" onclick="restart()" style="margin-top: 30px;">
                    새로운 평가 시작하기
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <script>
        // Firebase 설정 (실제 프로젝트에서는 환경변수 사용)
        const firebaseConfig = {
            apiKey: "AIzaSyDl937FR878C_DQ8bqGqf3SkanOcFUaK-o",
            authDomain: "cdp-sorry927.firebaseapp.com",
            databaseURL: "https://cdp-sorry927-default-rtdb.firebaseio.com",
            projectId: "cdp-sorry927",
            storageBucket: "cdp-sorry927.firebasestorage.app",
            messagingSenderId: "433401427684",
            appId: "1:433401427684:web:d81ccb9549a0651b101ef1"
        };

        // Firebase 초기화
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // 문항 데이터
        const questionData = {
            backend: [
                {
                    id: 'backend1',
                    title: 'Java, Python, Golang, TypeScript, JavaScript 중 최소 2개 이상의 언어를 능숙하게 사용할 수 있다.',
                    category: '프로그래밍 언어',
                    section: '백엔드 개발자',
                    scores: [
                        '언어의 기본적인 문법과 개념을 잘 알지 못함',
                        '최소 1개 언어의 기본 문법을 이해',
                        '2개 이상의 언어를 실무에서 사용한 경험',
                        '2개 이상의 언어를 고급 수준으로 활용',
                        '2개 이상의 언어에 대한 전문성을 갖추고 기술적 리더 역할'
                    ]
                },
                {
                    id: 'backend2',
                    title: 'Spring Boot, Next.js와 같은 프레임워크를 다룬 경험이 있다.',
                    category: '프레임워크',
                    section: '백엔드 개발자',
                    scores: [
                        '프레임워크를 사용한 경험이 없음',
                        '프레임워크의 개념은 알고 있지만 사용 경험이 거의 없음',
                        '간단한 프로젝트나 기능 개발 경험',
                        '실무 프로젝트에서 주요 기능 개발 경험',
                        '대규모 시스템 설계 및 개발, 고급 기능 활용 경험'
                    ]
                },
                {
                    id: 'backend3',
                    title: '프레임워크의 기본 동작 원리를 이해하고, 최적화된 개발 환경을 구축한 경험이 있다.',
                    category: '개발환경',
                    section: '백엔드 개발자',
                    scores: [
                        '프레임워크의 기본 동작 원리를 이해하지 못함',
                        '기본 동작 원리를 일부 이해하나 환경 구축 경험 부족',
                        '동작 원리를 기본적으로 이해하고 개발 환경 설정 경험',
                        '여러 프로젝트에서 최적화된 개발 환경 구축 경험',
                        '동작 원리를 깊이 이해하고 고급 설정 및 라이브러리 활용'
                    ]
                },
                {
                    id: 'backend4',
                    title: 'RESTful API 설계 및 개발 경험이 있다.',
                    category: 'API 설계',
                    section: '백엔드 개발자',
                    scores: [
                        'RESTful API 설계 및 개발 경험이 없음',
                        '간단한 API 설계 및 CRUD 기능 구현 가능',
                        'RESTful API 설계하고 인증, 권한, 상태 코드 활용',
                        '고급 기능을 통합한 효율적이고 확장성 있는 API 설계',
                        '대규모 시스템에서 API 설계 주도 및 조직 내 표준화'
                    ]
                },
                {
                    id: 'backend5',
                    title: '외부 및 내부 시스템과의 통합연동을 위한 API 설계 및 구현 경험이 있다.',
                    category: '시스템 연동',
                    section: '백엔드 개발자',
                    scores: [
                        'API 연동 경험이 없고 기본 개념을 잘 이해하지 못함',
                        '단순한 외부 API 호출 및 기본적인 인증 방식 사용',
                        '외부 및 내부 시스템 간의 API 설계 및 구현 경험',
                        '대규모 시스템의 확장성, 성능 최적화를 고려한 API 설계',
                        '대규모 분산 시스템에서 복잡한 API 통합 연동 주도'
                    ]
                }
            ],
            frontend: [
                {
                    id: 'frontend1',
                    title: 'JavaScript 사용에 능숙하다.',
                    category: 'JavaScript',
                    section: '프론트엔드 개발자',
                    scores: [
                        'JavaScript 기본 문법과 사용법에 익숙하지 않음',
                        '기본적인 문법과 로직은 작성 가능하나 복잡한 처리는 미숙',
                        '일반적인 개발 과제를 해결하고 ES6+ 문법 활용',
                        'JavaScript의 동작 원리를 이해하고 복잡한 문제 해결',
                        'JavaScript 전문가로서 최적화, 멘토링, 코드 품질 향상'
                    ]
                },
                {
                    id: 'frontend2',
                    title: 'TypeScript를 활용한 프로젝트 경험이 있다.',
                    category: 'TypeScript',
                    section: '프론트엔드 개발자',
                    scores: [
                        'TypeScript 사용 경험이 거의 없고 개념 이해 부족',
                        'TypeScript의 기본 문법을 이해하고 제한적으로 사용',
                        '실무 프로젝트에서 TypeScript 사용하고 기본 타입 시스템 활용',
                        'TypeScript를 대규모 프로젝트에 적용하고 고급 타입 활용',
                        'TypeScript 전문가로 프로젝트 설계, 교육, 멘토링, 오픈소스 기여'
                    ]
                },
                {
                    id: 'frontend3',
                    title: 'React 프레임워크 경험이 있다.',
                    category: 'React',
                    section: '프론트엔드 개발자',
                    scores: [
                        'React 프레임워크의 개념을 알지 못하고 실무 경험 없음',
                        'React의 기본 개념을 이해하고 간단한 컴포넌트 작성',
                        'React로 컴포넌트 설계하고 상태 관리, 라우팅 경험',
                        'React로 복잡한 상태 관리 및 최적화, 다양한 기능 구현',
                        'React 고급 기능 적용과 다양한 라이브러리 연동 경험'
                    ]
                },
                {
                    id: 'frontend4',
                    title: 'HTML5의 웹 표준 및 시맨틱 태그를 이해하고 있다.',
                    category: 'HTML5',
                    section: '프론트엔드 개발자',
                    scores: [
                        'HTML5 기본 문법과 웹 표준, 시맨틱 태그 역할을 이해하지 못함',
                        'HTML5의 기본 태그 사용하나 시맨틱 태그 활용이 미숙',
                        '웹 표준과 시맨틱 태그를 실무에서 활용하고 기본 SEO 적용',
                        '접근성과 SEO를 고려한 HTML5 설계와 크로스 브라우징 해결',
                        'HTML5 표준과 시맨틱 태그 설계를 선도하고 프로젝트 표준화'
                    ]
                },
                {
                    id: 'frontend5',
                    title: 'CSS3와 관련된 레이아웃, 애니메이션, 그리드 시스템을 이해하고 있다.',
                    category: 'CSS3',
                    section: '프론트엔드 개발자',
                    scores: [
                        'CSS의 기본 개념에 익숙하지 않고 레이아웃 설계에 어려움',
                        '기본 레이아웃과 간단한 애니메이션 구현 가능하나 고급 기능은 미숙',
                        'Flexbox와 CSS Grid 활용하고 트랜지션과 애니메이션으로 UI 개선',
                        '복잡한 레이아웃 및 애니메이션 설계와 반응형 디자인에 능숙',
                        'CSS3 전문가로 고급 레이아웃 설계, 성능 최적화, 팀 표준화'
                    ]
                }
            ],
            common: [
                {
                    id: 'common1',
                    title: 'Git을 사용해 코드 버전 관리를 할 수 있다.',
                    category: '버전 관리',
                    section: '직무 공통',
                    scores: [
                        'Git의 기본 개념을 이해하나 프로젝트에 사용한 경험 없음',
                        '개인 실무에서 Git을 활용하고 간단한 충돌 해결 경험',
                        '실무에서 팀원들과 협업하고 브랜치 전략 및 PR/MR 작업 수행',
                        '대규모 프로젝트에서 Git 워크플로 설계 및 관리, CI/CD 통합',
                        'Git 전문가로 오픈소스 기여, 교육, 조직과 업계 기여'
                    ]
                },
                {
                    id: 'common2',
                    title: '변화하는 기술에 빠르게 적응하고 학습할 수 있는 능력이 있다.',
                    category: '학습 능력',
                    section: '직무 공통',
                    scores: [
                        '기술 트렌드의 필요성을 인식하나 학습하거나 적용한 경험 없음',
                        '새로운 기술을 학습하나 실무 프로젝트에 적용하지 못함',
                        '새로운 기술을 빠르게 학습하고 실무 프로젝트에 적용하여 성과',
                        '대규모 프로젝트에서 새로운 기술 도입하고 팀원들에게 전파',
                        '기술 트렌드를 선도하고 조직 및 업계 기여, 글로벌 커뮤니티 영향력'
                    ]
                },
                {
                    id: 'common3',
                    title: '클린 코드 작성 원칙을 이해하고 이를 실천하고 있다.',
                    category: '코드 품질',
                    section: '직무 공통',
                    scores: [
                        '클린 코드 작성 원칙에 대한 이해와 경험이 없음',
                        '클린 코드 원칙의 기본 개념을 이해하고 간단한 원칙 적용',
                        '클린 코드 원칙을 적용하여 가독성과 유지보수성 향상',
                        '대규모 프로젝트에서 클린 코드 원칙을 주도적으로 실천',
                        '클린 코드 작성의 전문가로 조직 내 코드 품질 표준화 주도'
                    ]
                }
            ]
        };

        // 전역 변수
        let selectedJob = '';
        let responses = {};
        let allQuestions = [];
        let currentPage = 0;
        let userInfo = {};
        let responseId = '';
        const questionsPerPage = 4;

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('페이지 로드 완료');
            // URL 파라미터 확인 (결과 조회)
            checkUrlParams();
            updateStartButton();
        });

        // URL 파라미터로 결과 조회
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const resultId = urlParams.get('result');
            
            if (resultId) {
                loadPreviousResult(resultId);
            }
        }

        // 이전 결과 불러오기
        async function loadPreviousResult(resultId) {
            try {
                const snapshot = await database.ref('responses/' + resultId).once('value');
                const data = snapshot.val();
                
                if (data) {
                    document.getElementById('job-selection').style.display = 'none';
                    document.getElementById('assessment-form').style.display = 'none';
                    document.getElementById('results').style.display = 'block';
                    
                    // 전역 데이터에서 평균 계산하여 결과 표시
                    const analysis = await analyzeWithComparison(data.responses, data.userInfo.job);
                    displayResults(analysis, data.userInfo, resultId);
                }
            } catch (error) {
                console.error('결과 불러오기 실패:', error);
                alert('결과를 불러올 수 없습니다.');
            }
        }

        // 이벤트 리스너
        document.addEventListener('click', function(e) {
            // 직무 선택 이벤트
            const jobOption = e.target.closest('.job-option');
            if (jobOption) {
                selectedJob = jobOption.getAttribute('data-job');
                console.log('선택된 직무:', selectedJob);
                
                // UI 업데이트
                document.querySelectorAll('.job-option').forEach(option => {
                    option.classList.remove('selected');
                });
                jobOption.classList.add('selected');
                
                updateStartButton();
                return;
            }
            
            // 점수 선택 이벤트
            const scoreOption = e.target.closest('.score-option');
            if (scoreOption) {
                const questionId = scoreOption.getAttribute('data-question');
                const score = parseInt(scoreOption.getAttribute('data-score'));
                
                // 같은 문항의 다른 선택 해제
                document.querySelectorAll(`[data-question="${questionId}"].score-option`).forEach(opt => {
                    opt.classList.remove('selected');
                    opt.style.borderColor = '#e2e8f0';
                });
                
                // 현재 선택 표시
                scoreOption.classList.add('selected');
                
                // 응답 저장
                if (!responses[questionId]) {
                    responses[questionId] = {};
                }
                responses[questionId].score = score;
                
                // 카테고리 정보 찾기
                const questionInfo = allQuestions.find(q => q.id === questionId);
                if (questionInfo) {
                    responses[questionId].category = questionInfo.category;
                }
                
                // 에러 스타일 제거
                const experienceInput = document.querySelector(`[data-question="${questionId}"].experience-input`);
                if (experienceInput) {
                    experienceInput.classList.remove('error');
                }
            }
        });

        // 경험 입력 이벤트
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('experience-input')) {
                const questionId = e.target.getAttribute('data-question');
                if (!responses[questionId]) {
                    responses[questionId] = {};
                }
                responses[questionId].experience = e.target.value;
                
                // 에러 스타일 제거
                if (e.target.value.trim() !== '') {
                    e.target.classList.remove('error');
                }
            }
        });

        // 함수 정의
        function updateStartButton() {
            const startBtn = document.getElementById('start-btn');
            const userName = document.getElementById('user-name').value.trim();
            const isJobSelected = selectedJob !== '';
            const isValidInput = userName !== '' && isJobSelected;
            
            console.log('버튼 상태 업데이트:', selectedJob, userName, isValidInput);
            
            startBtn.disabled = !isValidInput;
        }

        // 사용자 정보 입력 감지
        document.getElementById('user-name').addEventListener('input', updateStartButton);

        function startAssessment() {
            console.log('평가 시작, 선택된 직무:', selectedJob);
            
            const userName = document.getElementById('user-name').value.trim();
            const userDepartment = document.getElementById('user-department').value.trim();
            const userEmail = document.getElementById('user-email').value.trim();
            
            if (!selectedJob || !userName) {
                alert('이름을 입력하고 직무를 선택해주세요.');
                return;
            }
            
            // 사용자 정보 저장
            userInfo = {
                name: userName,
                department: userDepartment,
                email: userEmail,
                job: selectedJob,
                startTime: new Date().toISOString()
            };
            
            // 문항 설정
            if (selectedJob === 'fullstack') {
                allQuestions = [...questionData.backend, ...questionData.frontend, ...questionData.common];
            } else if (selectedJob === 'backend') {
                allQuestions = [...questionData.backend, ...questionData.common];
            } else if (selectedJob === 'frontend') {
                allQuestions = [...questionData.frontend, ...questionData.common];
            }
            
            console.log('설정된 문항 수:', allQuestions.length);
            
            // 응답 초기화
            responses = {};
            currentPage = 0;
            
            // 화면 전환
            document.getElementById('job-selection').style.display = 'none';
            document.getElementById('assessment-form').style.display = 'block';
            
            // 첫 페이지 표시
            displayCurrentPage();
        }

        function displayCurrentPage() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';
            
            const startIndex = currentPage * questionsPerPage;
            const endIndex = Math.min(startIndex + questionsPerPage, allQuestions.length);
            const currentQuestions = allQuestions.slice(startIndex, endIndex);
            
            // 현재 페이지의 문항들을 섹션별로 그룹화
            const sectionGroups = {};
            
            currentQuestions.forEach((question, index) => {
                const section = question.section;
                if (!sectionGroups[section]) {
                    sectionGroups[section] = [];
                }
                sectionGroups[section].push({
                    question,
                    questionNumber: startIndex + index + 1
                });
            });
            
            // 섹션 순서 정의
            const sectionOrder = ['백엔드 개발자', '프론트엔드 개발자', '직무 공통'];
            
            // 정의된 순서대로 섹션 표시
            sectionOrder.forEach(section => {
                if (sectionGroups[section] && sectionGroups[section].length > 0) {
                    // 섹션별 스타일 클래스 결정
                    let sectionClass = '';
                    if (section === '백엔드 개발자') sectionClass = 'backend';
                    else if (section === '프론트엔드 개발자') sectionClass = 'frontend';
                    else if (section === '직무 공통') sectionClass = 'common';
                    
                    // 섹션 헤더 추가
                    const sectionHeader = document.createElement('div');
                    sectionHeader.className = `section-header ${sectionClass}`;
                    sectionHeader.textContent = section;
                    container.appendChild(sectionHeader);
                    
                    // 해당 섹션의 문항들 추가
                    sectionGroups[section].forEach(({ question, questionNumber }) => {
                        const questionCard = createQuestionCard(question, questionNumber);
                        container.appendChild(questionCard);
                    });
                }
            });
            
            updatePageInfo();
            updateNavigationButtons();
            updateProgressBar();
        }

        function createQuestionCard(question, questionNumber) {
            const card = document.createElement('div');
            card.className = 'question-card';
            
            // 기존 응답 확인
            const existingResponse = responses[question.id];
            const selectedScore = existingResponse ? existingResponse.score : null;
            const existingExperience = existingResponse ? existingResponse.experience || '' : '';
            
            card.innerHTML = `
                <div class="question-title">
                    ${questionNumber}. ${question.title} <span class="required-indicator">*</span>
                </div>
                
                <div class="score-options">
                    ${question.scores.map((score, index) => `
                        <div class="score-option ${selectedScore === index + 1 ? 'selected' : ''}" 
                             data-score="${index + 1}" data-question="${question.id}">
                            <div class="score-label">${index + 1}점</div>
                            <div class="score-desc">${score}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div style="margin-top: 20px;">
                    <label style="font-weight: 600; color: #2d3748; margin-bottom: 10px; display: block;">
                        ${questionNumber}-1. 선택한 점수에 대한 구체적인 경험을 작성해주세요. <span class="required-indicator">*</span>
                    </label>
                    <textarea class="experience-input" 
                              data-question="${question.id}" 
                              placeholder="구체적인 경험이나 프로젝트 사례를 작성해주세요...">${existingExperience}</textarea>
                </div>
            `;
            
            return card;
        }

        function updatePageInfo() {
            const totalPages = Math.ceil(allQuestions.length / questionsPerPage);
            const pageInfo = document.getElementById('page-info');
            pageInfo.textContent = `${currentPage + 1} / ${totalPages} 페이지`;
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const totalPages = Math.ceil(allQuestions.length / questionsPerPage);
            
            prevBtn.disabled = currentPage === 0;
            
            if (currentPage === totalPages - 1) {
                nextBtn.textContent = '결과 분석하기';
                nextBtn.onclick = generateResults;
            } else {
                nextBtn.textContent = '다음';
                nextBtn.onclick = nextPage;
            }
        }

        function updateProgressBar() {
            const progress = ((currentPage + 1) / Math.ceil(allQuestions.length / questionsPerPage)) * 100;
            document.getElementById('progress-bar').style.width = progress + '%';
        }

        function validateCurrentPage() {
            const startIndex = currentPage * questionsPerPage;
            const endIndex = Math.min(startIndex + questionsPerPage, allQuestions.length);
            const currentQuestions = allQuestions.slice(startIndex, endIndex);
            
            let isValid = true;
            
            currentQuestions.forEach(question => {
                const response = responses[question.id];
                const scoreSelected = response && response.score;
                const experienceWritten = response && response.experience && response.experience.trim() !== '';
                
                if (!scoreSelected || !experienceWritten) {
                    isValid = false;
                    
                    // 에러 스타일 적용
                    if (!scoreSelected) {
                        document.querySelectorAll(`[data-question="${question.id}"].score-option`).forEach(opt => {
                            opt.style.borderColor = '#e53e3e';
                        });
                    }
                    
                    if (!experienceWritten) {
                        const experienceInput = document.querySelector(`[data-question="${question.id}"].experience-input`);
                        if (experienceInput) {
                            experienceInput.classList.add('error');
                        }
                    }
                }
            });
            
            if (!isValid) {
                alert('1~5점 중 하나를 선택하고 선택한 점수에 대한 관련 경험에 대한 내용을 작성해주세요.');
                return false;
            }
            
            return true;
        }

        function nextPage() {
            if (!validateCurrentPage()) {
                return;
            }
            
            const totalPages = Math.ceil(allQuestions.length / questionsPerPage);
            if (currentPage < totalPages - 1) {
                currentPage++;
                displayCurrentPage();
            }
        }

        function previousPage() {
            if (currentPage > 0) {
                currentPage--;
                displayCurrentPage();
            }
        }

        async function generateResults() {
            if (!validateCurrentPage()) {
                return;
            }
            
            // 로딩 화면 표시
            document.getElementById('assessment-form').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            
            try {
                // Firebase에 응답 저장
                const responseData = {
                    userInfo: userInfo,
                    responses: responses,
                    completedAt: new Date().toISOString(),
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                // 응답을 Firebase에 저장
                const newResponseRef = await database.ref('responses').push(responseData);
                responseId = newResponseRef.key;
                
                console.log('응답 저장 완료, ID:', responseId);
                
                // 전체 데이터와 비교하여 분석
                const analysis = await analyzeWithComparison(responses, selectedJob);
                
                // 결과 표시
                displayResults(analysis, userInfo, responseId);
                
                // 화면 전환
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'block';
                
            } catch (error) {
                console.error('결과 저장 실패:', error);
                alert('결과 저장에 실패했습니다. 다시 시도해주세요.');
                
                // 로딩 화면 숨기고 평가 화면으로 복귀
                document.getElementById('loading').style.display = 'none';
                document.getElementById('assessment-form').style.display = 'block';
            }
        }

        async function analyzeWithComparison(currentResponses, jobType) {
            let totalScore = 0;
            let maxScore = 0;
            const categoryScores = {};
            
            // 개인 점수 계산
            for (const [questionId, response] of Object.entries(currentResponses)) {
                if (response.score) {
                    totalScore += response.score;
                    maxScore += 5;
                    
                    if (!categoryScores[response.category]) {
                        categoryScores[response.category] = { total: 0, count: 0 };
                    }
                    categoryScores[response.category].total += response.score;
                    categoryScores[response.category].count += 1;
                }
            }
            
            // 개인 평균 점수 계산 (5점 만점 기준으로 환산)
            const personalAverage = maxScore > 0 ? (totalScore / (maxScore / 5)) : 0;
            
            // 조직 평균과 비교
            let organizationAverage = null;
            let jobTypeAverage = null;
            
            try {
                // Firebase에서 전체 응답 데이터 가져오기
                const snapshot = await database.ref('responses').once('value');
                const allResponses = snapshot.val();
                
                if (allResponses) {
                    const responseValues = Object.values(allResponses);
                    
                    // 전체 평균 계산
                    organizationAverage = calculateAverageFromResponses(responseValues);
                    
                    // 같은 직무 평균 계산
                    const sameJobResponses = responseValues.filter(r => r.userInfo.job === jobType);
                    if (sameJobResponses.length > 1) { // 본인 포함해서 2명 이상일 때만
                        jobTypeAverage = calculateAverageFromResponses(sameJobResponses);
                    }
                }
            } catch (error) {
                console.error('평균 계산 실패:', error);
            }
            
            return {
                personal: {
                    totalScore,
                    maxScore,
                    averageScore: personalAverage, // 5점 만점 기준 평균 점수
                    categoryScores,
                    questionsCount: Object.keys(currentResponses).length
                },
                comparison: {
                    organizationAverage,
                    jobTypeAverage
                }
            };
        }

        function calculateAverageFromResponses(responses) {
            if (!responses || responses.length === 0) return null;
            
            let totalSum = 0;
            let totalQuestions = 0;
            const categoryTotals = {};
            const categoryCounts = {};
            
            responses.forEach(responseData => {
                if (responseData.responses) {
                    Object.values(responseData.responses).forEach(response => {
                        if (response.score && response.category) {
                            totalSum += response.score;
                            totalQuestions++;
                            
                            if (!categoryTotals[response.category]) {
                                categoryTotals[response.category] = 0;
                                categoryCounts[response.category] = 0;
                            }
                            categoryTotals[response.category] += response.score;
                            categoryCounts[response.category]++;
                        }
                    });
                }
            });
            
            if (totalQuestions === 0) return null;
            
            // 5점 만점 기준 평균 점수 계산
            const overallAverage = totalSum / totalQuestions;
            
            const categoryAverages = {};
            Object.keys(categoryTotals).forEach(category => {
                categoryAverages[category] = categoryTotals[category] / categoryCounts[category];
            });
            
            return {
                overall: overallAverage, // 5점 만점 기준 평균
                categories: categoryAverages,
                sampleSize: responses.length
            };
        }

        function displayResults(analysis, userData, resultId) {
            const container = document.getElementById('results-content');
            
            // 개인 평균 점수 (소수점 2자리까지)
            const personalScore = analysis.personal.averageScore.toFixed(2);
            
            let resultHTML = `
                <div class="summary-card">
                    <div class="summary-value">${personalScore}점</div>
                    <div class="summary-label">개인 평균 점수 (5점 만점)</div>
                </div>
            `;
            
            // 비교 분석 카드
            if (analysis.comparison.organizationAverage || analysis.comparison.jobTypeAverage) {
                resultHTML += `<div class="comparison-card">`;
                
                resultHTML += `
                    <div class="comparison-item">
                        <h4>개인 점수</h4>
                        <div class="comparison-value">${personalScore}점</div>
                    </div>
                `;
                
                if (analysis.comparison.organizationAverage) {
                    const orgScore = analysis.comparison.organizationAverage.overall.toFixed(2);
                    resultHTML += `
                        <div class="comparison-item">
                            <h4>조직 평균</h4>
                            <div class="comparison-value">${orgScore}점</div>
                            <small>(${analysis.comparison.organizationAverage.sampleSize}명 기준)</small>
                        </div>
                    `;
                }
                
                if (analysis.comparison.jobTypeAverage) {
                    const jobScore = analysis.comparison.jobTypeAverage.overall.toFixed(2);
                    resultHTML += `
                        <div class="comparison-item">
                            <h4>${userData.job} 평균</h4>
                            <div class="comparison-value">${jobScore}점</div>
                            <small>(${analysis.comparison.jobTypeAverage.sampleSize}명 기준)</small>
                        </div>
                    `;
                }
                
                resultHTML += `</div>`;
            }
            
            resultHTML += `<h3 style="color: #5a67d8; margin-bottom: 20px;">📊 카테고리별 역량 분석</h3>`;
            
            for (const [category, data] of Object.entries(analysis.personal.categoryScores)) {
                const categoryAvg = (data.total / data.count).toFixed(2);
                const orgAvg = analysis.comparison.organizationAverage?.categories[category];
                const jobAvg = analysis.comparison.jobTypeAverage?.categories[category];
                
                resultHTML += `
                    <div class="skill-item">
                        <div class="skill-name">
                            ${category}
                            ${orgAvg ? `<br><small style="color: #666;">조직평균: ${orgAvg.toFixed(2)}점</small>` : ''}
                            ${jobAvg ? `<br><small style="color: #666;">${userData.job}평균: ${jobAvg.toFixed(2)}점</small>` : ''}
                        </div>
                        <div class="skill-score">${categoryAvg}점</div>
                    </div>
                `;
            }
            
            // 개선 권장사항 생성
            resultHTML += generateRecommendations(analysis);
            
            container.innerHTML = resultHTML;
            
            // 공유 URL 설정
            const shareUrl = `${window.location.origin}${window.location.pathname}?result=${resultId}`;
            document.getElementById('share-url').textContent = shareUrl;
        }

        function generateRecommendations(analysis) {
            let recommendations = [];
            const personalData = analysis.personal;
            const comparison = analysis.comparison;
            
            // 개인 평균 점수 기준 권장사항 (5점 만점 기준)
            const personalScore = personalData.averageScore;
            
            if (personalScore < 2.0) {
                recommendations.push('기본적인 개발 역량 습득을 위한 체계적인 학습이 필요합니다.');
                recommendations.push('온라인 강의나 부트캠프를 통한 기초 역량 강화를 권장합니다.');
            } else if (personalScore < 3.0) {
                recommendations.push('실무 프로젝트 경험을 늘려 실전 역량을 향상시키세요.');
                recommendations.push('코드 리뷰나 페어 프로그래밍을 통해 코드 품질을 개선하세요.');
            } else if (personalScore < 4.0) {
                recommendations.push('고급 기술 스택 학습과 아키텍처 설계 경험을 쌓으세요.');
                recommendations.push('팀 내에서 기술적 리더십을 발휘할 기회를 찾아보세요.');
            } else {
                recommendations.push('전문성을 바탕으로 조직 내 기술 표준화를 주도하세요.');
                recommendations.push('외부 커뮤니티나 오픈소스 기여를 통해 영향력을 확장하세요.');
            }
            
            // 조직 평균과 비교한 권장사항
            if (comparison.organizationAverage) {
                const orgDiff = personalScore - comparison.organizationAverage.overall;
                if (orgDiff > 0.5) {
                    recommendations.push('조직 평균보다 높은 역량을 보유하고 있어 멘토 역할을 고려해보세요.');
                } else if (orgDiff < -0.5) {
                    recommendations.push('조직 평균 수준 달성을 위한 체계적인 학습 계획을 수립하세요.');
                }
            }
            
            // 카테고리별 권장사항
            for (const [category, data] of Object.entries(personalData.categoryScores)) {
                const categoryAvg = data.total / data.count;
                if (categoryAvg < 3.0) {
                    recommendations.push(`${category} 영역의 기본기 강화가 필요합니다.`);
                }
            }
            
            return `
                <div class="recommendations">
                    <h3>💡 개선 권장사항</h3>
                    <ul>
                        ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        function copyShareUrl() {
            const shareUrl = document.getElementById('share-url').textContent;
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert('링크가 복사되었습니다!');
            }).catch(() => {
                // 복사 실패 시 대체 방법
                const textArea = document.createElement('textarea');
                textArea.value = shareUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('링크가 복사되었습니다!');
            });
        }

        function restart() {
            selectedJob = '';
            responses = {};
            allQuestions = [];
            currentPage = 0;
            userInfo = {};
            responseId = '';
            
            // 입력 필드 초기화
            document.getElementById('user-name').value = '';
            document.getElementById('user-department').value = '';
            document.getElementById('user-email').value = '';
            
            // 직무 선택 초기화
            document.querySelectorAll('.job-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // 버튼 상태 초기화
            updateStartButton();
            
            // URL 파라미터 제거
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // 화면 전환
            document.getElementById('results').style.display = 'none';
            document.getElementById('assessment-form').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('job-selection').style.display = 'block';
        }
    </script>
</body>

</html>
